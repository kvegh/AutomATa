---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# rhel8only
# https://cloud.redhat.com/insights/remediations/bec023a5-35fb-41b2-a01a-4dcfed24104e
# Generated by Red Hat Insights on Tue, 09 Feb 2021 08:34:54 GMT
# Created by kvegh@redhat.com

# The dnf installs lower versions of packages when the &quot;best&quot; option is not present in the &#x2F;etc&#x2F;dnf&#x2F;dnf.conf
# Identifier: (advisor:dnf_install_update_issue|DNF_INSTALL_UPDATE_ISSUE_INFO,fix)
# Version: c5f5b1e58368e0156a586ef1b276dd4c86533c2d
# autotest rhel8.2
- name: Set best opiton to True in /etc/dnf/dnf.conf
  hosts: "rhel-kvegh-demo4-801.kveghdemo.at"
  become: true

  tasks:
  - name: Check if /etc/dnf/dnf.conf file exists
    stat:
       path: /etc/dnf/dnf.conf
    register: reg_dnf_conf

  - name: Set best option in file /etc/dnf/dnf.conf
    lineinfile:
      path: /etc/dnf/dnf.conf
      insertafter: '^\[main\]'
      line: "best=True"
      state: present
      backup: True
    when: reg_dnf_conf.stat.exists


# Decreased security: OpenSSH ClientAlive settings
# Identifier: (advisor:hardening_ssh_client_alive|OPENSSH_HARDENING_CLIENT_ALIVE,fix)
# Version: c988b9061f0c3720900ae391d72a59a89bf57294
- name: Set ClientMaxAlive and ClientAliveInterval. Restart sshd service.
  hosts: "rhel-kvegh-demo4-801.kveghdemo.at"
  become: yes
  tasks:
    - name: Update ClientAliveInterval setting
      lineinfile:
        dest: /etc/ssh/sshd_config
        backup: yes
        regexp: '(?i)^\s*ClientAliveInterval\s+[0-9]+'
        line: 'ClientAliveInterval 300'

    - name: Update ClientMaxAlive setting
      lineinfile:
        dest: /etc/ssh/sshd_config
        backup: yes
        regexp: '(?i)^\s*ClientAliveCountMax\s+[0-9]+'
        line: 'ClientAliveCountMax 0'

    - name: restart sshd service
      service:
        name: sshd
        state: restarted


- name: run insights
  hosts: "rhel-kvegh-demo4-801.kveghdemo.at"
  vars:
    insights_signature_exclude: "/hosts"
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false