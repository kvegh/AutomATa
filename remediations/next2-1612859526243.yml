---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# next2
# https://cloud.redhat.com/insights/remediations/1be1ad82-034c-4502-ab80-645e4d6c260f
# Generated by Red Hat Insights on Tue, 09 Feb 2021 08:32:06 GMT
# Created by kvegh@redhat.com

- name: run insights to obtain latest diagnosis info
  hosts: "rhel-kvegh-demo4-711.kveghdemo.at"
  vars:
    insights_remediation: " 1be1ad82-034c-4502-ab80-645e4d6c260f"
    insights_signature_exclude: "/hosts,/vars/insights_remediation"
  become: True
  tasks:
    - name: obtain diagnosis info
      command: "insights-client --diagnosis{{ remediation | regex_search('[a-fA-F0-9]{8}[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}') }}"
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# Decreased security: System log permissions
# Identifier: (advisor:hardening_logging_log_perms|HARDENING_LOGGING_3_LOG_PERMS,default_perms)
# Version: 7b6bf61ac2a54eda32e0b1bb47df180004994534
- name: Fix hardening_logging_log_perms issue
  hosts: "rhel-kvegh-demo4-711.kveghdemo.at"
  become: true
  vars:
    pydata: '{{ insights_report.details["hardening_logging_log_perms|HARDENING_LOGGING_3_LOG_PERMS"] }}'
    perms:
      "/var/log": { owner: "root", group: "root", mode: "u=rw,o-w" }
      "/var/log/wtmp": { owner: "root", group: "utmp", mode: "u=rw,g-x,o-wx" }
      "/var/log/btmp": { owner: "root", group: "utmp", mode: "u=rw,g-rwx,o-rwx" }
      "/var/log/audit": { owner: "root", group: "root", mode: "u=rw,o-rwx" }
      "/var/log/boot.log": { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/dmesg": { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/lastlog": { owner: "root", group: "utmp", mode: "u=rw,g-x,o-wx" }
      "/var/log/messages": { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/spooler": { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/tallylog": { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/yum.log": { owner: "root", group: "root", mode: "u=rw,g-x,o-wx" }
      "/var/log/cron": { owner: "root", group: "root", mode: "u=rw,g-x,o-rwx" }
      "/var/log/maillog": { owner: "root", group: "root", mode: "u=rw,g-x,o-rwx" }
      "/var/log/secure": { owner: "root", group: "root", mode: "u=rw,g-x,o-rwx" }

  tasks:
    - when: insights_report.details["hardening_logging_log_perms|HARDENING_LOGGING_3_LOG_PERMS"] is defined
      block:
        - name: Set the correct permissions on affected log files
          file:
            path: "{{ item.log_perms_dirfilename }}"
            owner: "{{ perms[item.log_perms_dirfilename]['owner'] }}"
            group: "{{ perms[item.log_perms_dirfilename]['group'] }}"
            mode: "{{ perms[item.log_perms_dirfilename]['mode'] }}"
          with_items: "{{ pydata.detected_problem_log_perms }}"


- name: run insights
  hosts: "rhel-kvegh-demo4-711.kveghdemo.at"
  vars:
    insights_signature_exclude: "/hosts"
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false