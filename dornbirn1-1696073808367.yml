---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# Dornbirn1
# https://console.redhat.com/insights/remediations/2ff09c1b-a5c7-42f7-8290-4798d36121be
# Generated by Red Hat Insights on Sat, 30 Sep 2023 11:36:48 GMT
# Created by kvegh@redhat.com

- name: run insights to obtain latest diagnosis info
  hosts: "rhel-kvegh-ld23-711.kveghdemo.at"
  vars:
    insights_remediation: " 2ff09c1b-a5c7-42f7-8290-4798d36121be"
    insights_signature_exclude: "/hosts,/vars/insights_signature,/vars/insights_remediation"
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRblZqZG5jMU9FUXJhalZ3VGtGUmFtRkdVa0ZCYTBSVWNu
      UnZRVzFSVkRBdlFVODVaRlJyYlRablJHZHRabUkyVGxGMGFVNEtPWHBNYmtWcmRsaEpibVZQV2s0
      MWRGcDBPSEZWWmtaaFNYQnBSMEV5SzFGWU9GVlNaR2hWTDJOdmRIbDRLMWQ2UlZscU1sSlpaSEEz
      ZEVnM01IQXpWUXBpWjFwbVRGRTNkV2wxYm5NNGIwMXFaV3N5VURaVFVWcExXRmxhV1c0NVYyZENP
      V2R2VG5FMk9FZERXbXR3Um1KVFVqWXJTRVl3TWxwYVVUUlZTV0ZtQ21Ga05XSmplWElyZVVwbFoy
      TlFVVk5RYUhscmNtaGtaV1pQWm5ORk9YUlhlVmhXUjFwSk1ETnNXSGh3VEVaSlJsQlFZWFZRUzNB
      NE5WcHBha0Y0VjNvS2RHYzRTSGRGUjJzME5HRTFRa3BqYVdsdWQyNXJWV1pDVEc0NFVHeHVPRVF2
      TjNSc1NsZExUVWh4TmtsWVkwMW1NVzlVU1RKdWMzZDFXRkZzTUhsbWRRcHNUekYwVHpkWFpHVTJO
      QzlHT0dGdVptNVpUVUZ5TjNoamIxTTJaMU5sTDJWeWRuVnZOamt3YVVOWFYyWm5SV294WVhSd1Qx
      cDJjazF5YmxkSllYUlhDakZrYUVONFVqaGFabkE1UmxsQ2RXUnhZV05yYVhGWVNtNDBjbEppTTFo
      clFVWlNUVmQ0YTBseWJFVkdkRUZKYjJveVdrNDJabGRVYjJwQ1JVTmlRbmNLZG14RmQxWmxObGhR
      ZW5WYWVVRm9Sa0ZFZGxWcU1UZElLME01VnpCd1ZrcHlkM3BSVUV0cE1DOXJlRTFOZVV0UWJ6ZDNa
      R3BEU0dsalFtdHRRVk01TXdwR1ZYbzVUMWcxY0RRNFpIa3lhV1p6TDBOblIyMW5XWFZEWjI1UllW
      QjNWMkpHTUhkMGREQmlWVk55WldkUldWZ3JkV3hJTlhOQlJtMW9TVUZ1Ym1GdENsTkNWVUV5ZFZr
      MVpsZGlPVXhzTmpablIwcGlUSGxNY1ZSUVNFcFNTbWxXWjNKTEt6VnpTMHgyZDNnMmNqTXJjVnBr
      YTFoUVIza3hSM0ZTVlZKT1NGUUtXWFoxVm5sUGRIZHZVV2xCUm1rdlJYWmxPV05xV2xwdWEwcDVW
      MlZUV1RodVVtNDFlbll5TkhSUWJGSkdVVk5xZWtscWMxSlNhVVJvYzA1UWFGUlRhd3AxZGxkYVdI
      SjBWVlpoUlQwS1BVMDNMek1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  become: true
  tasks:
    - name: obtain diagnosis info
      command: "insights-client --diagnosis{{ insights_remediation | regex_search('\\s[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}') }}"
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# Decreased security: System log permissions
# Identifier: (advisor:hardening_logging_log_perms|HARDENING_LOGGING_3_LOG_PERMS,default_perms)
# Version: 9788a2d4ce207e3a7d0208e1627e79969b1f052f
- name: Fix hardening_logging_log_perms issue
  hosts: "rhel-kvegh-ld23-711.kveghdemo.at"
  become: true
  vars:
    pydata: '{{ insights_report.details["hardening_logging_log_perms|HARDENING_LOGGING_3_LOG_PERMS"] }}'
    perms:
      "/var/log": {owner: "root", group: "root", mode: "u=rw,o-w"}
      "/var/log/wtmp": {owner: "root", group: "utmp", mode: "u=rw,g-x,o-wx"}
      "/var/log/btmp": {owner: "root", group: "utmp", mode: "u=rw,g-rwx,o-rwx"}
      "/var/log/audit": {owner: "root", group: "root", mode: "u=rw,o-rwx"}
      "/var/log/boot.log": {owner: "root", group: "root", mode: "u=rw,g-x,o-wx"}
      "/var/log/dmesg": {owner: "root", group: "root", mode: "u=rw,g-x,o-wx"}
      "/var/log/lastlog": {owner: "root", group: "utmp", mode: "u=rw,g-x,o-wx"}
      "/var/log/messages": {owner: "root", group: "root", mode: "u=rw,g-x,o-wx"}
      "/var/log/spooler": {owner: "root", group: "root", mode: "u=rw,g-x,o-wx"}
      "/var/log/tallylog": {owner: "root", group: "root", mode: "u=rw,g-x,o-wx"}
      "/var/log/yum.log": {owner: "root", group: "root", mode: "u=rw,g-x,o-wx"}
      "/var/log/cron": {owner: "root", group: "root", mode: "u=rw,g-x,o-rwx"}
      "/var/log/maillog": {owner: "root", group: "root", mode: "u=rw,g-x,o-rwx"}
      "/var/log/secure": {owner: "root", group: "root", mode: "u=rw,g-x,o-rwx"}
    insights_signature_exclude: /hosts,/vars/insights_signature,/vars/pydata
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVc3dWRkZ6ZG5jMU9FUXJhalZ3VGtGUmFrNVZlRUZCWjBvelRr
      Y3ZNekZwV2xKNlZFTlVNMFF4VlRNNE0xQkxVM05VZUZwNk5uVUtaMVZWV1dsaWNHdHBaMHB4VkVz
      MFNsbzJTWFkxVTJ0MmVUQmFWRll3VlRWYU9FdHNXazFPYTFvd1NIbDZiMHhxYzFGcVdETTRVVGxh
      YkhoVVFYTmhXUW95Wkc5eVRHUkpURTVzUlhWaE9VVmpXV041TkdwUU9XcHVRVU5SVjNCQmNtNTFk
      a294TVd4MldXazFVa055TWxvMVNtOTNVMVJSV2xoS2FqTXdXbk41Q2tGSWNqVTRLMFpEY2xGR2JX
      eFdWbGhGVnk5M1VqSTVTakp4U2pKRFVVNDRaMVl6UkUxcUsyTkxiMUp1WVZOa2FqWnpkbUpFZEhC
      ek5YVlZRME5NU0dVS1RGRjNSbmxsYjNjeVJuUkJkbUU0UzBsV2JFNUZjRkpOWVVSalVHMW1UVGw0
      Um5oa1luTTBlR3AyVEVGdFZIWnFaemxOZG1WWU9HSjVWM1Z1VUZjeldncFlaMVk0YTJOWlkwOVla
      aTlxU1VFNUt6UlllbEJCVDNaQlp6RnpTV0ZsWWxkNlIyNTRSa0Y1WWt0bmNIQlhjSGR1YWtaaWFX
      NTRURVJwUnpCYWEzQkpDbU42TUdjMWFWRjBNVWRCYnpOVFVreHdSMUIyT0hoWVpYWjNTekpYTDFW
      R01VcGpNMjVzY0VkclpYWlljVXB6YzFKSU1YQkZhRlkyZVdwMVJXOXJhRklLV25CTFVFdENVWFpL
      TkRaSGJVY3pSM1JNZHpJelptRmtUMWR6UmpNeWJIUlRhSGtyVjA1TVJsWnRjelFyVkZaaVlVcG5N
      SGhZTjJsUU5DOXlkVkJrWXdwV1ptdEVXRVk0T0cxMFYwczBNMWRKZWxsTWNtUlBWWFZEZVRSVWVq
      TkdPV2hQV0ROdU5sbG5Va2RNTVhsTFZHcG9UbGsxTldwSk1sWnpRVFZ0Y0ZaR0NuSndLMnh0VG05
      eFZFdGlPVFZsTVhKU1FYZHlNSGxPZW5oeFZXbGxXazFhVjBGdWNtRlFUMkpHT1M5Q1lsRnFaRGxT
      VTJZNFNtMWxXV2QzU25KdlNsb0tVRWQxUTJWU1IxSkljbGQ0YTBGWmRFbHNhbU5CSzBoalFVZFpV
      MHRoVlhWdVNHc3ZUblp3TWpWTVpqaDNiMjF6VEdNMlJXRlFNbnAzVEVaaFpFSTRkUXBQZFZVMkwx
      aHRXR2RPT0QwS1BXRTJWVmdLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==


  tasks:
    - when: insights_report.details["hardening_logging_log_perms|HARDENING_LOGGING_3_LOG_PERMS"] is defined
      block:
        - name: Set the correct permissions on affected log files
          file:
            path: "{{ item.log_perms_dirfilename }}"
            owner: "{{ perms[item.log_perms_dirfilename]['owner'] }}"
            group: "{{ perms[item.log_perms_dirfilename]['group'] }}"
            mode: "{{ perms[item.log_perms_dirfilename]['mode'] }}"
          with_items: "{{ pydata.detected_problem_log_perms }}"


# Decreased security: OpenSSH ClientAlive settings
# Identifier: (advisor:hardening_ssh_client_alive|OPENSSH_HARDENING_CLIENT_ALIVE,fix)
# Version: 9788a2d4ce207e3a7d0208e1627e79969b1f052f
- name: Set ClientMaxAlive and ClientAliveInterval. Restart sshd service.
  hosts: "rhel-kvegh-ld23-711.kveghdemo.at"
  become: yes
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVc3hUV2ROZG5jMU9FUXJhalZ3VGtGUmFYaEplRUZCYkZOYWFU
      UmlkMWQyTTNrM1ZHOHhja04yUmtacE5GcGhSMmhXY1hOdFFrWUtNaTg1UW1WR1pVcFZRVmhYTm5o
      dGIyazJjMlZ4TVRaUmJYcE9RMFZuVVc1SVNGTlpkM0pPTlVVelNWZFVOVXRLWmxGbVFXSlhSVWR4
      UlRGM1oxVjRXQXB1ZVhkNWMwRklkbk5pYkhkb05WVTBlVUZDVFdnMmF6SjJObk4xV1dGSmRrWnpk
      VE0wVldwaWNGQkJkVlYwTmtObmFtUjJia3B4YVhCcWRtdzFUWFF4Q2pWRFRUSlNPRWRuTmxCMU5u
      bHdhVWRaTVhsTWFHWm5hMlpGV25ScGIyRTBMelI2TVhGNU5FNUlTMGxxYVM4d1RXWkJRbE1yTUV3
      dk5XazRNVlp1YmxNS1dVNVZSM0pWVVNzNVprNVZUMmh0TWxOSk1sY3JRbGhLUlN0dGFsUjFRVm8y
      VEhac1JYaEVSbVIyU0c4NWRFbG9aMjQ1UVV0aFN6SmlPVTFrZG1NclN3cHpkMDF6WjJwamRGbHhO
      MnRzWmtrelQxRm9aak4wVlVWM1ZEZEliVGxqTVdRNE1ESndlak56YUZGSVZpdG9XRmRTY0RocE1t
      VkRkR2xOYzB4VEszVTFDbVl5Y1hJMFQyNVdWMDFaUkdwNVNrSnRjR1ZLTkVGa1RrTlVPVFpNVG10
      SGJ6WkxSRVpIWWk5TFRHVjRjM0ZVT0hGSWEyVlJOMEU0YmpoSU5uZFVSMHNLT0hWMmFFOXRSVk5u
      WW1ZMFVUWmtNRTlZZUVab1JrNVBiMjV6T0ZGMFRFZDZZVGt3Vm1kRVlscHNiRFJRTXpOb1kxWnpi
      eTl2V2xSVmRYUTNVRFJ6TlFvdmRVUXdjbU0xZVdSc2RtNDRSVE13UmsxR1JVRmxabWhRWmpsdFIz
      TllTM0F2TUZoT05rTlVXVzFsY0dadk1GbEJkWHBtZUVwa1NDdFdTeXRoVVVzekNpOUZkMmd4Y1Ro
      cVNrMVlhRzFPV0RScVFYaFRNMk5uY0VoclZtcFJNSEZ5ZVRObGFHUm9kMGN5SzNsVllqZ3hNbXRK
      U2pGSU5EWlJNV3BaVUZkNWRXd0tWRXgxYzJkMVdsb3ZjRzUxVUN0eVEwbE9ibWMyVFdSTmJFRTVX
      alJuWVZrek4xTjJlVWhwY2toVmNUTkpUVzk0VTNZeVRqUlpVbmRHVjJ0SU1WQmxSZ3BxZFc1b1Rq
      ZExPWEJCUVQwS1BVeHVlSG9LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: Update ClientAliveInterval setting
      lineinfile:
        dest: /etc/ssh/sshd_config
        backup: yes
        regexp: '(?i)^\s*ClientAliveInterval\s+[0-9]+'
        line: 'ClientAliveInterval 300'

    - name: Update ClientMaxAlive setting
      lineinfile:
        dest: /etc/ssh/sshd_config
        backup: yes
        regexp: '(?i)^\s*ClientAliveCountMax\s+[0-9]+'
        line: 'ClientAliveCountMax 0'

    - name: restart sshd service
      service:
        name: sshd
        state: restarted


# Decreased security: OpenSSH Ciphers and MACs settings
# Identifier: (advisor:hardening_ssh_hmac_cipher|OPENSSH_HARDENING_HMAC_CIPHER_2,fix)
# Version: 9788a2d4ce207e3a7d0208e1627e79969b1f052f
- name: Update openssh-server package, replace Ciphers and MACs line in /etc/ssh/sshd_config and restart sshd service
  hosts: "rhel-kvegh-ld23-711.kveghdemo.at"
  become: true
  vars:
    pydata: "{{ insights_report.details['hardening_ssh_hmac_cipher|OPENSSH_HARDENING_HMAC_CIPHER_2'] | default('') }}"
    insights_signature_exclude: /hosts,/vars/insights_signature,/vars/pydata
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVc3hUbVJqZG5jMU9FUXJhalZ3VGtGUmFXRklVUzhyVGpab2Fs
      cEtkWG9yUXpSQmVEZHlUa1k1YkdSRFQyTldaMU14YmxoQ01UTUtiVkpxYVROSVkxRnhlamwwV1dW
      M2VFMVRkRWx0YW5wWlRYaHJkbUZGZEZaSVdWZzFXRlJJV1VGTWRrcDFkbWhHWTJKcWFFMHJTRXRq
      UVhKd1NEYzJSd293YzBoR1FXOVZWbkkyUzA5RVVXbHhhMDlFYjFJeFN6TXpSMFpEUlRkSlFuZHll
      RE0wVkcxakt6SkJlV1pQTURORGJERnZjVUkwTVhJNE1rUk5NWGxaQ21SWVVXZERPRFIzY1ZWM2Ju
      bzRVR2wxZVVSMWNIVlBXakV6YTJaTE4wRXhWbVZoWWxWRlNIaGlWQ3RCTTI5ek0zQTNha1ZZSzJK
      UVVHSXJOV1JDZDFZS0syTmxkRFpXZG5FMWFrSjZiR1ZpU0VsS01VZHlNaXRUV0RSblNIUm9OV2RL
      WjJKdWFXY3lURXg1ZWpneFdYTlJXVVpsZUZoYVpGRjZTbTh3VkhVNU1BcGtUSFJ3UldWQ2FrMXFV
      RXh0YUROV2FURjVkbXBWWnpWaFpFMW5XWEJwTDFsSGNVZDZVa1pVVlhwR1kyUm9lalJJYldkWk1G
      ZGxOamRzVGpOQlNHZzJDalZxUmxwdllXUndZbk51WW10SGJHMUtSRWhRU0ZCTlJrZEZkVkZFVFdF
      elMxWlZaMjlWVFdOclFreDVWakZoTms5c2JrNURUSFZ0YURJMlExZDRiV3NLYUZCQ1FrNDVTMEZE
      SzNBNVNYcDZObEl3YlN0VWVtWnRPRXBRUW1oQlZrTm5Wa05oUTJoc0wwSkxkM1ZDUmtWUVdEaFhW
      VVJFYlVSdVdrTm9ibXcxYUFwS1NXNVpRMngxUlVsM2VGZFhLM0YxV1RWS05VOUxXRWhTU0dad2NG
      ZERhVEl5YWt3MFMzTmpTRWt3WWxJck5HdHdSbWgxVHpNMk1XRnRVbmRaYzFCS0NrVXlTbFZYT1cx
      dlJrcGxTVlZzVDA1M1IxQTBkVWQzVjFnNGN6ZzNhR1EzTUM4MGExZEdMMmR6YVU0eWFWaFJabEZ2
      WWpGdVQwVXdNMm92YkM5MlYyOEtUVEUwUkZkNlJ6RlRaV05hYXk5TWNrNWlUbmhCYTFCc01YZFZh
      R0p3VkhSS0swWlROa0p1U1hGR1pGZ3dWSEV5VkcxTWRHWkhVR2QwZWtWR1oyTm9WUXBRWTNFMlVr
      a3lUVkUzWXowS1BUaGpaWFlLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==


  tasks:
    - when:
        - pydata.fixable_by_updating is defined
        - pydata.fixable_by_updating
      name: Update openssh-server package
      yum:
        name: openssh-server
        state: latest

    - when:
        - pydata.ciphers_recomm is defined
        - pydata.ciphers_recomm
      name: Replace Ciphers line in etc/ssh/sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: ^\s*Ciphers
        line: Ciphers {{ ",".join(pydata.ciphers_recomm) }}
        backup: yes

    - when:
        - pydata.macs_recomm is defined
        - pydata.macs_recomm
      name: Replace MACs line in etc/ssh/sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: ^\s*MACs
        line: MACs {{ ",".join(pydata.macs_recomm) }}
        backup: yes

    - name: Restart sshd service
      service:
        name: sshd
        state: restarted


# Privilege Escalation: Systemd unit files with insecure permissions or ownership
# Identifier: (advisor:hardening_systemd_units|SYSTEMD_UNITS_INSECURE,fix)
# Version: b26310c106891875075bf8d16600f16fdec64b20
- name: Fix insecure permissions and ownership of systemd unit files
  hosts: "rhel-kvegh-ld23-711.kveghdemo.at"
  become: true
  vars:
    pydata: "{{ insights_report.details['hardening_systemd_units|SYSTEMD_UNITS_INSECURE'] | default('') }}"
    all_dirs: "{{ (pydata.perms_dirs | default([]) + (pydata.owner_dirs) | default([])) | unique }}"
    all_found_files: []
    wrong_perms_exec_or_write_files: []
    wrong_perms_nonroot_group_write_files: []
    wrong_owner_files: []
    insights_signature_exclude: /hosts,/vars/insights_signature,/vars/pydata
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldUYzNRbmx6ZG5jMU9FUXJhalZ3VGtGUmFGTk9aeTg1UmpFMlFV
      SkxaMFkwWTNseFRqSk5ZalozUlRFeGJqSnhhM1pQWlZjM1Iyd0tOUzh6TWprd2JrNUtlRkZpUTNV
      cmMzRnVka1pWVEZsRFYzRmhOMkZUY0c1ek5VWkNhREZ4YmxVNVdrb3lRbFJJWjJ0bmJsY3hTamcz
      Y2xSMmRWRjVOZ3BRZUdOaGNXbFphR2hHZWpGUGRraDZVWGhNVVVsVmMxZHRTMUZCT1RoTGNEazBj
      RzVZV2s0ek9YSm1VbXBHVUhsdU5VczBNRWRwYVhGQlZYbHRXbXcxQ2xOUFVIVlFUbm9yUzFwaE5T
      OWpSbXBtYkhjemFFMHpNRkV6Ym1wYVVHOXJjRUozUVhSSWMzQkNjRWxGWkVZMU5XSTNTMFJoUjB4
      TGJVbHdNM2xITmtVS1RubDROWEpXTDFoWUszSmhUemxZYWxOTFp6bHNTblZxUnpKQlNscERhR1l6
      TVhsS1QxZzFTVlJhYTFkTVRHWkxjRUY2Y0VOR2IwaEVWRmRGVFRscWFncGFjemt2TDFGcmVFMWpW
      SEY2SzNKMFNEaE1TVTkzUzNONVFVWlpiakIzZFdoSlpVSTJMMGRUVVV4Qk1XSnVTbUY2V1hOblJr
      NXNNRk5OY0RSWmFtUnFDbVZHTm1SUmEybDNaamcxSzBsRFJHaDRZazFwTTFkYVJXUnJSR3QyZVdw
      WGRTdENSU3RGVldSbllXZFBNMlZMU1ZKNlEyUndhbGgzVXk5R1pIcFlWa2NLT1hsQk1GUlJOR1pz
      U0U4eU1Vb3dVemhEWWtOdlJuSm1iVzFQYkhCaFJVMTFjVXhLVFcxdmFGVXhZa3BCUVdSdFJGWlpS
      SE5tVkVoTmJXSTNPVmhSUVFwNlRsQkpjVWh0T0U1WllsVXZNeXRUUnpGcVRWaGlNV1ZNYTBadmNU
      Um5UV2hXUVRsU2RtUTBOWEZVWWtOWlIybHRaSEZOVVVGcVZHczFhbkY1TTNaRkNtSjZaSGxSWVdW
      S00yODViVmxTVnpaWFVIUndRMmN2VkRCTVRGRTJOREpTTkdwM1Z6aExPVTFwVjJwRlVtcDVMM1Zw
      TWxKUFZqRlFja2gyVGtwMU5pOEtVekEyTDNabE1qTlBUMDlIUjJSSFRTOU9OV1JSWlVKVlpETjZN
      RlJOYTBjNU5YVkxLM3BuTUhoVFVqQjZjek52UWpOM1JEUjRkR2ROU25vMldYUnBjZ3BtUkV3NGNu
      ZFFabW81YnowS1BXMUlPRzRLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==

  tasks:
    - block:
        - name: Find all regular files listed in 'perms_dirs' and 'owner_dirs' and store them
          find:
            paths: "{{ all_dirs }}"
            patterns:
              - '*.service'
              - '*.socket'
              - '*.device'
              - '*.mount'
              - '*.automount'
              - '*.swap'
              - '*.target'
              - '*.path'
              - '*.timer'
              - '*.slice'
              - '*.scope'
            file_type: file
            hidden: yes
          register: all_found_regular_files

        - name: Find all symbolic links listed in 'perms_dirs' and 'owner_dirs' and store them
          find:
            paths: "{{ all_dirs }}"
            patterns:
              - '*.service'
              - '*.socket'
              - '*.device'
              - '*.mount'
              - '*.automount'
              - '*.swap'
              - '*.target'
              - '*.path'
              - '*.timer'
              - '*.slice'
              - '*.scope'
            file_type: link
            hidden: yes
          register: all_found_symbolic_links

        - name: Retrieve genuine information of symbolic links
          stat:
            path: "{{ item }}"
            follow: yes
          loop: "{{ all_found_symbolic_links.files | map(attribute='path') | list }}"
          register: stat_files

        - name: Set the final list of files to check
          set_fact:
            all_found_files: "{{ all_found_regular_files.files + stat_files.results | map(attribute='stat') | selectattr('isreg', '==', true) | list }}"
      when: all_dirs|length > 0

    - name: Identify files with insecure permissions or ownership
      set_fact:
        wrong_perms_exec_or_write_files: "{{ (all_found_files | selectattr('xusr', '==', true) | map(attribute='path') | list + all_found_files | selectattr('xgrp', '==', true) | map(attribute='path')\
          \ | list + all_found_files | selectattr('xoth', '==', true) | map(attribute='path') | list + all_found_files | selectattr('woth', '==', true) | map(attribute='path') | list ) | unique }}"
        wrong_perms_nonroot_group_write_files: "{{ all_found_files | selectattr('gr_name', '!=', 'root') | selectattr('wgrp', '==', true) | map(attribute='path') | list }}"
        wrong_owner_files: "{{ all_found_files | selectattr('pw_name', '!=', 'root') | map(attribute='path') | list }}"
      when: all_found_files|length > 0

    - name: Fix "execute" or "others write" permissions of all systemd unit files
      file:
        path: "{{ item }}"
        mode: a-x,o-w
      loop: "{{ wrong_perms_exec_or_write_files }}"
      when: wrong_perms_exec_or_write_files|length > 0

    - name: Fix "group write" permissions of all systemd unit files if the group is other than "root"
      file:
        path: "{{ item }}"
        mode: g-w
      loop: "{{ wrong_perms_nonroot_group_write_files }}"
      when: wrong_perms_nonroot_group_write_files|length > 0

    - name: Fix owner of all systemd unit files
      file:
        path: "{{ item }}"
        owner: root
      loop: "{{ wrong_owner_files }}"
      when: wrong_owner_files|length > 0

    - name: Reload systemd unit files
      systemd:
        daemon_reload: yes
      when: (wrong_perms_exec_or_write_files + wrong_perms_nonroot_group_write_files + wrong_owner_files) | length > 0


# Unsupported kernel version on Intel Purley Platform with Intel Skylake CPU
# Identifier: (advisor:intel_purley_skylake_supportable|INTEL_PURLEY_SKYLAKE_SUPPORTABLE,fix)
# Version: 88d3721bac44b2a2e88cb6e470364af46a2b22d3
- name: Update kernel
  hosts: "rhel-kvegh-ld23-711.kveghdemo.at"
  become: true

  vars:
    pydata: "{{ insights_report.details['intel_purley_skylake_supportable|INTEL_PURLEY_SKYLAKE_SUPPORTABLE'] | default('') }}"
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldUSlROVmx6ZG5jMU9FUXJhalZ3VGtGUmFqWktaeTh2WkZWSmNX
      NUJZWFIzZFRWc2JETkJiMUpEWmt4cWFGaHZMMnB6VEVGNk1qZ0tlbHBCU0c5NVNuWTFZM013Y0VF
      NVRuazNibEJKYjI0NWN6ZEVhbUZLY1VVeE0xUjFkMmxLZUdNellWUTJha0ZqUzNNeU9XUmhTMEZv
      VFc5RFJreDNWd294TWpOdFVscHpkM0pVZW5ObFJVTTBjek5zTVc1RVJXZGtWVE55VEhGQmR6QmpW
      RGhTWW5KcWRtODVkelYzVVdOU1NHcEZZV3RxVmt0Sk16ZEVXVk4wQ2swNWNtUk1ZVkJOTmxOMUwx
      bElaQzh5TVRkek5sQXJlbUpSV0RodlRteEJLMUpzZVhFMGQwTlNTamgwUjBRMFNtOTVOVFZNUms1
      S05HVlROMVJ5U1djS1FVZHVNbGhYZUcxWk9UVjVlRGsxVmtoSFFWaG1LMjVyYVhKdlFrSXZSelZw
      TkU5WlkzUnRNakpRUjNoemVreE9NRk5KY1N0R1ZYQXZTbE5xVEZNeWJRb3dibk5PV21ZemVqWmtW
      RlZ3TWxsMWNFcHBhakJ1TjNnM2FXdFROSFZ5Vm5GR09VZE1kRVJ3UkVGRFVtWTRkMFJzT1cwMk5G
      Wk1iMlZNZWpWWGJEaFpDalZ0UW5wVFVHSjVSelJFZDJObE9ETkJaMUV6YWpaU2QyVXpTWFZMYjNo
      eFRXVktXa3BZVTNkeFdVZFJOVXhqVjI5RGQwbG1jeXR2YUZsS00yNWpLeThLTVZWMmVWbHBaM05p
      WVZVelVWbzFOME5EUnpkRE0zRlhlRUZOT0hoWWVuWjNkMXBMUlVsWldFZGlabkZsWlVZMmN6ZE1h
      V3hVVURKVFpEaHlMelJ0YkFwQ01FSXhRazAxYlRZM1dVWlNaREZIY1cxQ1duSTFVMHhKVWpacldT
      OVlkbVJOTDNSSk5FeENSeXN2VG5Ock5IaExjMHB1WlhwamVISktWVzV5VFZsVkNtZ3JWRVp0YTBW
      NldESXlXVm95WkRaalNsRmxVVzFyVG05c2NXNXRVWHByZVhGdFYwWlNUM05CYWt0VFRrRm5jVFJx
      TmxGblFTOUNabGwyZWswMlNtRUtTVmszUjNsSGMyUm9TWEI1Ym5kaE5uVjJWbTlMVFdWbWNEUTRN
      M0F4UmxwaFRreE9TVEZ1UkRoU1IyOURWa1Z5YVc1WkwwWlpLMHBDWW14SlJuVkliZ3BEVVRKR1RY
      TjRSVEZyU1QwS1BWUXhRMElLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: Unset the release
      command: subscription-manager release --unset
      when: pydata.cur_lock is defined and pydata.rcm_locks is defined

    - name: Enable base repo
      command: subscription-manager repos --enable="{{ pydata.no_base }}"
      when: pydata.no_base is defined and (pydata.cur_lock is not defined or (pydata.cur_lock is defined and pydata.rcm_locks is defined))

    - name: Enable required repo
      command: subscription-manager repos --enable="{{ item }}"
      when: pydata.cur_lock is defined and pydata.req_repos is defined and pydata.rcm_locks is not defined
      with_items: "{{ pydata.req_repos }}"

    - name: Update kernel to latest version to fix the issue
      yum:
        name: kernel
        state: latest
      register: kernel_update

    - when: kernel_update is changed
      name: set reboot fact
      set_fact:
        insights_needs_reboot: true

    - when: not kernel_update is changed
# The latest kernel is already installed so boot from it.  Sort the installed kernels
# by build time and select the one with the most recent build time
      block:
        - name: Installing kernel package version
          shell: rpm -q kernel --queryformat="%{buildtime}\t%{version}-%{release}.%{arch}\n" | sort -nr | head -1 | cut -f2
          register: latest_kernel
          check_mode: no

        - name: get configured default kernel
          command: /sbin/grubby --default-kernel
          register: default_kernel
          check_mode: no
          changed_when: false

        - when: default_kernel.stdout.split('-', 1)[1] != latest_kernel.stdout
          name: set the default kernel to the latest installed
          command: /sbin/grubby --set-default /boot/vmlinuz-{{ latest_kernel.stdout }}
          register: grub_change
          check_mode: no
          changed_when: grub_change.rc == 0

        - when: grub_change is changed
          name: set reboot fact
          set_fact:
            insights_needs_reboot: true


# Reboots a system if any of the preceeding plays sets the 'insights_needs_reboot' variable to true.
# The variable can be overridden to suppress this behavior.
- name: Reboot system (if applicable)
  hosts: "rhel-kvegh-ld23-711.kveghdemo.at"
  become: true
  gather_facts: false
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRMVk0ZG5jMU9FUXJhalZ3VGtGUmFrMUVRa0ZCYTJOeE1W
      WlhVbEF3VUVoMGRIRjBWMGt4UkZSdU4zcE1kbFUyU0hKd2QxSUtUbkJ3Um5SWGJWRktiM2xxYm1w
      bE5XUmFSemMxUTNCU1kzZGFPRU5XVW5sRlRVRXpVREExZW1Kc1UzSnFWbTUxVW5oNlpVeG1SbTFy
      YW1SRVJWcHdjZ3ByWTJ0d2FFazJSVUpIYWtJemEyaGFUalJ5YTNwUWRWQm1PR1pMUVdsSE1ESmxk
      SGhXVFZWV01tZHRkV3c0UjBJMmRIcEpkRk5uVFRGQlFYQkdORTFRQ2s1NFRDOUpUMlY2ZFdRMGFt
      VlFaV05KZWpGS1dtMTVkVGgzWTNoVFZqWkpTbTVPU1VGSGVHYzVWRUpVYzNNMFEwbHVaVlZXY0RG
      VWRrUlFPUzlHVXk4S2VGaFlaMFphWlM5VlZuQjBaRzA1ZDJkbmRVOXRiR2hvWVZCTVZHNU5Tbkoy
      UVRsV2FVUnZRVzV2WWt0b1VIbEtZMHBSYjJOTFdrRlRjVTF6ZWs1VWNncHVNek5JYlRoUk9IQnRW
      VTFLYldobU9VRnZkM2x4VW5GWVVHeHpXVGwzT0UxRU1WQkZjR3htY2pJeVlYTjFMMHhvYjNGNlIz
      TmtOMUUxTTJwdFMyNXBDaXM1Y0VjeWEzVkNSVXhpVVhoblRHcERiVlZsUzFCdmJuaFhjM0JuVFZs
      M2VYQjFaVFJvYnl0dmFsZG5WRGR2ZG1GbFRFNVRTMkV2UkZOS2JEWldRaThLZEd4YUwxUXJPRFZr
      Ym5ZclNWb3phbEJTZFM5bVpuZFBkVVpVV2xoNmVGTkJUalZSV1M5ak15c3hhbUZSTDBKeFdYTmhi
      M2RpUkZreGRXUXZVeXRsYVFwa2FEa3JWRkV5TlVKa1NYa3hibGh3ZWpoV1JHbHpjbEp3Y0VrNWFs
      SldWakkwTVVVelRVWkhka1ZaTm1aVFYzSlZWMWMzY0RKbFpUbGphelpOVlUweUNrNUZjRXBLWm5G
      UFNFdHBjRXRPZVRKdVFVRTJURmcxTHpNeGFWSk9VSEZZVXpKRVdqSlpkbVZTUTJOMmVDOHZPVTlo
      UzFWd1FsZElZVmxYYW5STU4wWUtSWFJWVEZGeFZESkJPVTF3WjFSU1RtOU5WbEZ4Y1haQ01GUlBP
      WE00TmxoTmRuUkdRa1IzYW5SbWIxSm9NRnBEYlUwME1FRlhRMHBxT0RKNlduTlRZUXBCYXpkUEsy
      UkpkMFl5VVQwS1BWcEtiallLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - when:
        - insights_needs_reboot is defined
        - insights_needs_reboot
      block:
        - name: Reboot system
          shell: sleep 2 && shutdown -r now "Ansible triggered reboot"
          async: 1
          poll: 0
          ignore_errors: true

        - name: Wait for system to boot up
          local_action:
            module: wait_for
            host: "{{ hostvars[inventory_hostname]['ansible_host'] | default(hostvars[inventory_hostname]['ansible_ssh_host'], true) | default(inventory_hostname, true) }}"
            port: "{{ hostvars[inventory_hostname]['ansible_port'] | default(hostvars[inventory_hostname]['ansible_ssh_port'], true) | default('22', true) }}"
            delay: 15
            search_regex: OpenSSH
            timeout: 300
          become: false

- name: run insights
  hosts: "rhel-kvegh-ld23-711.kveghdemo.at"
  become: true
  gather_facts: false
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRaXR6ZG5jMU9FUXJhalZ3VGtGUmFXdDRaeTh2WmtaRFoz
      QXlTblIxVEd0UU5qQnNTa3BZYm1GU1JGTjVjVVYwU0ZSNlRGY0tOVlZSVlc5MWEyUmpVRFJVUlZn
      d01EaDFhRkJHUzFaSmVrdFVTR2RsYTFOaU1UUXlkMjlQYm5sR2VUUnpRbEJrZEZoaGREVlliWEp0
      VGxsR1EwaEVWZ28xYVhSdlNrcDBPVzg1UWtkQlJVaDVZMFJ3SzBoNVNqWXphM0paZVRGUk1rOXVU
      azF3VjJaSmNtYzJUakJXVTJoa1JtVk1lR0ppTjBaMlpFaEpjbFo2Q2pJNGFrdHhOemx1Tm13eUx6
      aDZZVkJSTDFkWVZIWkNaMDVhUkVWTFJ6TmhSSFl3WVRkbWIyUnlPRWhEZGxseE5tNUhNRkZOY1RO
      U1ZFOXBkbFZtTTFnS1JuQnlhVTh2TDNKSlRDOVlSelE1TTA1NGFWSjBRakVyZEhSUk0wZHNhM1ZE
      ZFVwck1EQkdaREp0ZDNZNFprRnZaR2xUUW5aelQydEpZekZyV25adFN3cEJjR3BEY1ZKMWVHaExU
      MDgzYWxZM1FYSnRTV0p6TkhobVJrUkJVMkZaV2t4R01VMHZhME42ZWs1d1MwTjFhbE5hVUUxRlVt
      WlhhV2RHVGpGMWRqRjNDalpQSzB0b1pTdFJVRU5hUm5CV1kwVndSbTFSTVdwcWFrOVFPV2haSzNW
      alZWSnhSVEkyTlhGTWRuWnFSWE4wUW5WQk4xQkZNRVZ3UkRsaU5VaFZSM1lLTkZKemJXc3pNbFpC
      Vnl0WE5IWk1VRWQwZG1sQ00wSXpUbE0wZUhCdVIzSmlObGs1Y1cwNFZuVTJSRUZIV2xOYWRsbFlk
      bWQwTm1WR2N6RTVTVFZZUWdvMGVtcFVSRUlyTW1sT2NrcE9jM2d5YURoU1VGVnJMMmhZUzFKMGEy
      WnZZMlpKZVRkcGNWY3hiMGRsTlZSMmFqTTFSbXRqUld0YU9VRnpSMjl6WXpWMENuUlZkVlZJWWpS
      ME5EVTFSSE5EWlZWc1ZEZFNOakJDTTB4d1Z6TmlTRTF0YzFCMEx6RktNRFEwYm1KS2RFTkhUM1Jy
      UVVWWVRsVTJlbGxUTDNBMFFqSUtaSFYxY2tZdlNHUnFWWFJNVDNSdlNFTnlZVWd2WkZwaFRVNTZk
      MVZpZUc1VFZXUkdZU3R6TTBaNFJHczFVVkU0VVRaMVVucFpRbWw0WkcxeWREZGpUQXBKYTA1NlEy
      aHBRMDlrY3owS1BVMVZOMk1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false