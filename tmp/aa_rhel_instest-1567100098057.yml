---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# AA_rhel_instest
# https://cloud.redhat.com/insights/remediations/64af899c-f398-4cd2-aeca-2c40d3122ed5
# Generated by Red Hat Insights on Thu, 29 Aug 2019 17:34:58 GMT

- name: run insights to obtain latest diagnosis info
  hosts: rhel-instest1
  become: true
  tasks:
    - name: obtain diagnosis info
      shell: insights-client --diagnosis 64af899c-f398-4cd2-aeca-2c40d3122ed5
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# CPU vulnerable to side-channel attacks using Microarchitectural Data Sampling (CVE-2018-12130, CVE-2018-12126, CVE-2018-12127, CVE-2019-11091)
# Identifier: (advisor:CVE_2018_12130_cpu_kernel|CVE_2018_12130_CPU_KERNEL_NEED_UPDATE,update)
# Version: a801cdab26e61f3b864b75983f16082643aa0d13
# Playbook for CVE_2018_12130_CPU_KERNEL_NEED_UPDATE
- name: Apply updates for CVE-2018-12130/12126/12127/2019-11091
  hosts: rhel-instest1
  become: true
  vars:
    pydata: "{{insights_report.details['CVE_2018_12130_cpu_kernel|CVE_2018_12130_CPU_KERNEL_NEED_UPDATE'] | default('')}}"
  tasks:
    - when: pydata != ''
      block:
        - name: Update kernel
          when: not pydata.rt
          yum:
            name: kernel
            state: latest

        - name: Update kernel (rt)
          when: pydata.rt
          yum:
            name: kernel-rt
            state: latest

        - name: Find latest installed kernel
          shell: yum list kernel | tail -1 | awk '{ print $2 }' warn=False
          register: latest_kernel

        - name: Get current default kernel
          command: grubby --default-kernel
          register: grubby_default

        - when: latest_kernel.stdout not in grubby_default.stdout
          command: grubby --set-default={{ grubby_default.stdout | regex_replace('\d\.\d+\.\d+.*el\d', latest_kernel.stdout)}}

        # pbtest reboot
        - name: Reboot
          set_fact:
            insights_needs_reboot: true

# Reboots a system if any of the preceeding plays sets the 'insights_needs_reboot' variable to true.
# The variable can be overridden to suppress this behavior.
- name: Reboot system (if applicable)
  hosts: rhel-instest1
  become: true
  gather_facts: false
  tasks:
    - when:
        - insights_needs_reboot is defined
        - insights_needs_reboot
      block:
        - name: Reboot system
          shell: sleep 2 && shutdown -r now "Ansible triggered reboot"
          async: 1
          poll: 0
          ignore_errors: true

        - name: Wait for system to boot up
          local_action:
            module: wait_for
            host: "{{ hostvars[inventory_hostname]['ansible_host'] | default(hostvars[inventory_hostname]['ansible_ssh_host'], true) | default(inventory_hostname,
              true) }}"
            port: "{{ hostvars[inventory_hostname]['ansible_port'] | default(hostvars[inventory_hostname]['ansible_ssh_port'], true) | default('22', true) }}"
            delay: 15
            search_regex: OpenSSH
            timeout: 300
          become: false

- name: run insights
  hosts: rhel-instest1
  become: true
  gather_facts: false
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false
